<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Scraper Bookmarklet</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
      line-height: 1.6;
      color: #333;
    }
    h1 {
      color: #4285f4;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      font-size: 18px;
      margin-bottom: 30px;
    }
    .bookmarklet-container {
      background: #f5f5f5;
      border: 2px dashed #4285f4;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      margin: 30px 0;
    }
    .bookmarklet-link {
      display: inline-block;
      background: #4285f4;
      color: white !important;
      padding: 15px 30px;
      text-decoration: none !important;
      border-radius: 6px;
      font-weight: 500;
      font-size: 18px;
      cursor: move;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }
    .bookmarklet-link:hover {
      background: #3367d6;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      transform: translateY(-1px);
    }
    .bookmarklet-link:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .instructions {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .instructions h2 {
      margin-top: 0;
      color: #333;
    }
    .instructions ol {
      padding-left: 20px;
    }
    .instructions li {
      margin: 10px 0;
    }
    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    .feature {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #34a853;
    }
    .feature h3 {
      margin-top: 0;
      color: #34a853;
    }
    code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <h1>üìÖ Event Scraper</h1>
  <p class="subtitle">Extract events from any webpage and add them to your calendar</p>

  <div class="bookmarklet-container">
    <p><strong>Drag this link to your bookmarks bar:</strong></p>
    <a href="#" id="bookmarklet" class="bookmarklet-link">üìÖ Event Scraper</a>
    <p style="margin-top: 15px; color: #666; font-size: 14px;">
      Or right-click and "Add to Bookmarks"
    </p>
  </div>

  <script>
    // Bookmarklet code - loaded from bookmarklet/bookmarklet.js
    // This code is minified and set dynamically to keep the HTML clean
    const bookmarkletCode = "(function() {\n  'use strict';\n  \n  const API_URL = 'https://event-scraper-eight.vercel.app/api/extract-event'; // Will be updated for production\n  \n  // Function to extract structured event data\n  function extractStructuredData() {\n    let eventData = [];\n    \n    // 1. Try Schema.org JSON-LD\n    const jsonLdScripts = document.querySelectorAll('script[type=\"application/ld+json\"]');\n    jsonLdScripts.forEach(script => {\n      try {\n        const data = JSON.parse(script.textContent);\n        const events = Array.isArray(data) ? data : [data];\n        events.forEach(item => {\n          if (item['@type'] === 'Event' || (Array.isArray(item['@type']) && item['@type'].includes('Event'))) {\n            eventData.push(JSON.stringify(item));\n          }\n        });\n      } catch (e) {\n        console.error('Error parsing JSON-LD:', e);\n      }\n    });\n    \n    // 2. Try Schema.org Microdata\n    const microdataEvents = document.querySelectorAll('[itemtype*=\"schema.org/Event\"]');\n    microdataEvents.forEach(elem => {\n      eventData.push(elem.textContent);\n    });\n    \n    // 3. Try Open Graph tags\n    const ogTags = {};\n    document.querySelectorAll('meta[property^=\"og:\"]').forEach(meta => {\n      ogTags[meta.getAttribute('property')] = meta.getAttribute('content');\n    });\n    if (Object.keys(ogTags).length > 0) {\n      eventData.push(JSON.stringify(ogTags));\n    }\n    \n    // 4. Try hCalendar microformat\n    const hCalendarEvents = document.querySelectorAll('.vevent, .hcalendar');\n    hCalendarEvents.forEach(elem => {\n      eventData.push(elem.textContent);\n    });\n    \n    return eventData.join('\\n\\n');\n  }\n  \n  // Function to extract plain text as fallback\n  function extractPlainText() {\n    // Get the main content, avoiding scripts, styles, and navigation\n    const clone = document.body.cloneNode(true);\n    \n    // Remove unwanted elements\n    clone.querySelectorAll('script, style, nav, header, footer, iframe, noscript').forEach(el => el.remove());\n    \n    return clone.textContent.trim().replace(/\\s+/g, ' ').substring(0, 10000); // Limit to 10k chars\n  }\n  \n  // Function to create and show modal\n  function createModal() {\n    // Remove existing modal if any\n    const existing = document.getElementById('event-scraper-modal');\n    if (existing) existing.remove();\n\n    // Create modal overlay\n    const modal = document.createElement('div');\n    modal.id = 'event-scraper-modal';\n    modal.style.cssText = `\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.5);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 2147483647;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;\n    `;\n\n    // Create modal content container\n    const modalContent = document.createElement('div');\n    modalContent.id = 'event-scraper-modal-content';\n    modalContent.style.cssText = `\n      background: white;\n      border-radius: 12px;\n      max-width: 600px;\n      max-height: 80vh;\n      overflow-y: auto;\n      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n      position: relative;\n    `;\n\n    modal.appendChild(modalContent);\n    document.body.appendChild(modal);\n\n    // Close on overlay click\n    modal.addEventListener('click', (e) => {\n      if (e.target === modal) {\n        modal.remove();\n      }\n    });\n\n    return modalContent;\n  }\n\n  // Function to show loading state\n  function showLoading(container) {\n    container.innerHTML = `\n      <div style=\"padding: 40px; text-align: center;\">\n        <div style=\"\n          border: 4px solid #f3f3f3;\n          border-top: 4px solid #4285f4;\n          border-radius: 50%;\n          width: 40px;\n          height: 40px;\n          animation: event-scraper-spin 1s linear infinite;\n          margin: 0 auto 20px;\n        \"></div>\n        <p style=\"margin: 0; color: #666;\">Extracting event information...</p>\n        <style>\n          @keyframes event-scraper-spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n          }\n        </style>\n      </div>\n    `;\n  }\n\n  // Function to show error\n  function showError(container, message) {\n    container.innerHTML = `\n      <div style=\"padding: 30px;\">\n        <div style=\"background: #fee; border: 1px solid #fcc; padding: 20px; border-radius: 8px;\">\n          <h2 style=\"margin: 0 0 10px 0; color: #c33; font-size: 20px;\">Error</h2>\n          <p style=\"margin: 0 0 10px 0; color: #666;\">${message}</p>\n          <p style=\"margin: 10px 0 0 0; color: #999; font-size: 13px;\">\n            üí° Check the browser console (F12) for debugging information\n          </p>\n        </div>\n        <button onclick=\"document.getElementById('event-scraper-modal').remove()\" style=\"\n          margin-top: 20px;\n          width: 100%;\n          padding: 12px;\n          background: #4285f4;\n          color: white;\n          border: none;\n          border-radius: 6px;\n          font-size: 16px;\n          cursor: pointer;\n        \">Close</button>\n      </div>\n    `;\n  }\n  \n  // Main execution\n  async function main() {\n    // Extract content\n    let content = extractStructuredData();\n    let extractionMethod = 'structured data';\n\n    // Fallback to plain text if no structured data found\n    if (!content || content.trim().length === 0) {\n      content = extractPlainText();\n      extractionMethod = 'plain text';\n    }\n\n    if (!content || content.trim().length === 0) {\n      alert('No content found on this page.');\n      return;\n    }\n\n    // Log what we're sending for debugging\n    console.log('Event Scraper - Extraction method:', extractionMethod);\n    console.log('Event Scraper - Content length:', content.length, 'characters');\n    console.log('Event Scraper - Content preview:', content.substring(0, 500));\n    console.log('Event Scraper - Full content:', content);\n\n    // Create modal and show loading\n    const modalContent = createModal();\n    showLoading(modalContent);\n\n    try {\n      // Call API with timeout\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout\n\n      const response = await fetch(API_URL, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ text: content }),\n        signal: controller.signal,\n      });\n\n      clearTimeout(timeoutId);\n\n      if (!response.ok) {\n        throw new Error(`API request failed: ${response.status}`);\n      }\n\n      const html = await response.text();\n\n      // Log response for debugging\n      console.log('Event Scraper - API response length:', html.length, 'characters');\n      if (html.includes('No Event Found') || html.includes('event-scraper-error')) {\n        console.log('Event Scraper - No event found in response');\n        console.log('Event Scraper - Response HTML:', html);\n      } else {\n        console.log('Event Scraper - Event(s) found successfully');\n      }\n\n      // Display result in modal\n      modalContent.innerHTML = html;\n\n      // Add close button functionality to any existing close buttons in the response\n      const closeButtons = modalContent.querySelectorAll('[data-close-modal]');\n      closeButtons.forEach(btn => {\n        btn.addEventListener('click', () => {\n          document.getElementById('event-scraper-modal').remove();\n        });\n      });\n\n    } catch (error) {\n      console.error('Event Scraper - Error:', error);\n      console.error('Event Scraper - Error details:', error.message);\n      showError(modalContent, error.message);\n    }\n  }\n\n  main();\n})();\n\n";
    
    document.getElementById('bookmarklet').href = 'javascript:' + encodeURIComponent(bookmarkletCode);
  </script>

  <div class="instructions">
    <h2>How to Use</h2>
    <ol>
      <li>Drag the button above to your browser's bookmarks bar</li>
      <li>Navigate to any webpage with event information</li>
      <li>Click the bookmarklet in your bookmarks bar</li>
      <li>A modal will appear on the page with the extracted event(s)</li>
      <li>Click "Add to Google Calendar" or "Download ICS File" to save the event</li>
      <li>Click the √ó button or outside the modal to close it</li>
    </ol>
  </div>

  <div class="features">
    <div class="feature">
      <h3>üîç Smart Detection</h3>
      <p>Automatically detects structured event data (Schema.org, Open Graph, hCalendar) or falls back to AI-powered text extraction.</p>
    </div>
    <div class="feature">
      <h3>üì± Multiple Formats</h3>
      <p>Get both Google Calendar links and downloadable ICS files for compatibility with any calendar app.</p>
    </div>
    <div class="feature">
      <h3>üéØ Multiple Events</h3>
      <p>If a page contains multiple events, you'll see them all listed (up to 5) and can choose which to add.</p>
    </div>
  </div>

  <div class="instructions">
    <h2>Supported Event Formats</h2>
    <ul>
      <li><strong>Schema.org JSON-LD:</strong> Structured event data in JSON format</li>
      <li><strong>Schema.org Microdata:</strong> HTML with event markup</li>
      <li><strong>Open Graph:</strong> Facebook/social media event tags</li>
      <li><strong>hCalendar:</strong> Microformat event data</li>
      <li><strong>Plain Text:</strong> AI-powered extraction from any text content</li>
    </ul>
  </div>

  <div style="background: #e8f5e9; border: 1px solid #4caf50; border-radius: 8px; padding: 20px; margin: 30px 0; text-align: center;">
    <h3 style="margin-top: 0; color: #2e7d32;">üß™ Try It Out!</h3>
    <p style="margin-bottom: 15px;">Test the bookmarklet on our sample event page:</p>
    <a href="/test-event.html" style="display: inline-block; background: #4caf50; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: 500;">
      View Test Event Page ‚Üí
    </a>
  </div>

  <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666;">
    <p>Event Scraper - Powered by Gemini AI</p>
  </footer>
</body>
</html>

